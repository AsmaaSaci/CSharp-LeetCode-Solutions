public class Solution {
    public string ProcessStr(string s) {
        var res = new System.Text.StringBuilder();

        foreach (char c in s) {
            if (c != '*' && c != '#' && c != '%') {
                // Append regular characters
                res.Append(c);
            }
            else if (c == '#') {
                // Append current string to itself (concatenate)
                res.Append(res.ToString());
            }
            else if (c == '%') {
                // Reverse the current string
                ReverseStringBuilder(res);
            }
            else {
                // For '*', delete last character if any
                if (res.Length > 0) res.Length--;
            }
        }

        return res.ToString();
    }

    private void ReverseStringBuilder(System.Text.StringBuilder sb) {
        int left = 0, right = sb.Length - 1;
        while (left < right) {
            char temp = sb[left];
            sb[left] = sb[right];
            sb[right] = temp;
            left++;
            right--;
        }
    }
}
